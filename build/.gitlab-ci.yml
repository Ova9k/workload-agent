image: davidczech/go-tpm-sim:latest

before_script:
  - echo "Acquire::http::Proxy \"${HTTP_PROXY}\";" >> /etc/apt/apt.conf
  - echo "Acquire::https::Proxy \"${HTTPS_PROXY}\";" >> /etc/apt/apt.conf

  - git config --global http.proxy "${HTTP_PROXY}"
  - git config --global http."https://${GITLAB_SERVER}".proxy ""
  - git config --global url."https://gitlab-ci-token:${CI_JOB_TOKEN}@${GITLAB_SERVER}".insteadOf "https://${GITLAB_SERVER}"

  - echo "[http \"https://${GITLAB_SERVER}\"]" >> ~/.gitconfig
  - echo "        proxy = \"\"" >> ~/.gitconfig
  - cd $CI_PROJECT_DIR
variables:
  HTTPS_PROXY: "${HTTPS_PROXY}"
  no_proxy: "${NO_PROXY}"

stages:
  - build
  - test

test:
  stage: test
  tags:
    - go
  script:
    - start12 > /dev/null &
    - start20 > /dev/null &
    - start20_legacy > /dev/null &
    - sleep 3
    - provision12 1234 5678
    - provision20 1234 5678
    - provision20_legacy 1234 5678
    - go test ./... -coverpkg=./... -coverprofile cover.out
    - go tool cover -func cover.out
  
compile:
  tags:
    - go
  stage: build
  script:
    - go build ./...
